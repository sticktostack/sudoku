<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sudoku</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      margin: 0;
      padding: 40px 20px;
      min-height: 100vh;
    }
    
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 40px;
      max-width: 1400px;
      width: 100%;
      opacity: 0;
      animation: fadeInUp 0.8s ease forwards;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Hintbox panel */
    .hintbox-panel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-height: 900px;
      opacity: 0;
      animation: slideInLeft 0.8s ease 0.2s forwards;
    }
    
    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .hintbox-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      color: #333;
      text-align: center;
    }
    
    .hint-content {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      line-height: 1.5;
      color: #495057;
      border-left: 4px solid #6a11cb;
    }
    
    .hint-tips {
      margin-top: 10px;
    }
    
    .hint-tip {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 10px;
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
    }
    
    .hint-tip:nth-child(1) { animation-delay: 0.4s; }
    .hint-tip:nth-child(2) { animation-delay: 0.5s; }
    .hint-tip:nth-child(3) { animation-delay: 0.6s; }
    .hint-tip:nth-child(4) { animation-delay: 0.7s; }
    .hint-tip:nth-child(5) { animation-delay: 0.8s; }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .tip-icon {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    /* Sudoku grid */
    .grid-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      opacity: 0;
      animation: scaleIn 0.8s ease 0.4s forwards;
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(9, 50px);
      grid-template-rows: repeat(9, 50px);
      gap: 0;
      background: #333;
      border: 3px solid #333;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .cell {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 20px;
      font-weight: 500;
      border: none;
      outline: none;
      background: white;
      color: #333 !important; /* Added !important to ensure text color */
      transition: all 0.2s ease;
      opacity: 0;
      animation: cellFadeIn 0.5s ease forwards;
    }
    
    @keyframes cellFadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .cell:focus {
      background: #e0f7fa;
      box-shadow: inset 0 0 0 2px #4fc3f7;
      transform: scale(1.05);
      color: #333 !important; /* Ensure text color on focus */
    }
    
    /* 3x3 block borders */
    .cell:nth-child(3n) {
      border-right: 2px solid #333;
    }
    
    .cell:nth-child(n+19):nth-child(-n+27),
    .cell:nth-child(n+46):nth-child(-n+54) {
      border-bottom: 2px solid #333;
    }
    
    .cell:disabled {
      background: #f5f5f5;
      color: #333 !important; /* Ensure text color for disabled cells */
      font-weight: 700;
    }
    
    .highlight {
      background: #e8f5e9 !important;
      color: #333 !important; /* Ensure text color for highlighted cells */
    }
    
    .selected {
      background: #c8e6c9 !important;
      color: #333 !important; /* Ensure text color for selected cells */
    }
    
    /* Animation class for number insertion */
    .cell.number-inserted {
      animation: numberPulse 0.3s ease;
    }
    
    @keyframes numberPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Logic box */
    .logic-box {
      width: 100%;
      max-width: 500px;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid #f5576c;
      font-size: 14px;
      line-height: 1.5;
      color: #495057;
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .logic-box.visible {
      display: block;
    }
    
    .logic-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .logic-icon {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .logic-steps {
      margin-top: 10px;
    }
    
    .logic-step {
      margin-bottom: 6px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    
    .step-number {
      background: #e9ecef;
      color: #495057;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    /* Right panel */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 24px;
      opacity: 0;
      animation: slideInRight 0.8s ease 0.6s forwards;
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .panel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      width: 100%;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #333;
      text-align: center;
    }
    
    .num-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .num-buttons button,
    .control-buttons button {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      font-size: 18px;
      font-weight: 600;
      padding: 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
      opacity: 0;
      animation: buttonFadeIn 0.5s ease forwards;
    }
    
    .num-buttons button:nth-child(1) { animation-delay: 0.7s; }
    .num-buttons button:nth-child(2) { animation-delay: 0.75s; }
    .num-buttons button:nth-child(3) { animation-delay: 0.8s; }
    .num-buttons button:nth-child(4) { animation-delay: 0.85s; }
    .num-buttons button:nth-child(5) { animation-delay: 0.9s; }
    .num-buttons button:nth-child(6) { animation-delay: 0.95s; }
    .num-buttons button:nth-child(7) { animation-delay: 1.0s; }
    .num-buttons button:nth-child(8) { animation-delay: 1.05s; }
    .num-buttons button:nth-child(9) { animation-delay: 1.1s; }
    
    .control-buttons button:nth-child(1) { animation-delay: 1.2s; }
    .control-buttons button:nth-child(2) { animation-delay: 1.25s; }
    .control-buttons button:nth-child(3) { animation-delay: 1.3s; }
    
    @keyframes buttonFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .num-buttons button:hover,
    .control-buttons button:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(37, 117, 252, 0.4);
    }
    
    .num-buttons button:active,
    .control-buttons button:active {
      transform: translateY(1px);
    }
    
    .control-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .control-buttons button {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
    }
    
    .control-buttons button:hover {
      box-shadow: 0 7px 20px rgba(245, 87, 108, 0.4);
    }

    /* NEW UPLOAD STYLES */
    .upload-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .upload-button {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
      color: white;
      font-size: 16px;
      font-weight: 600;
      padding: 14px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(238, 90, 36, 0.3);
      width: 100%;
      opacity: 0;
      animation: buttonFadeIn 0.5s ease 1.35s forwards;
    }

    .upload-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(238, 90, 36, 0.4);
    }

    .upload-button:active {
      transform: translateY(1px);
    }

    .file-input {
      display: none;
    }

    .upload-status {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      display: none;
    }

    .upload-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .upload-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .upload-status.processing {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
      display: block;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
        align-items: center;
      }
      
      .hintbox-panel {
        width: 100%;
        max-width: 500px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 20px;
      }
      
      .grid {
        grid-template-columns: repeat(9, 40px);
        grid-template-rows: repeat(9, 40px);
      }
      
      .cell {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      .num-buttons button,
      .control-buttons button {
        padding: 12px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="hintbox-panel">
      <h2 class="hintbox-title">Sudoku Tips</h2>
      
      <div class="hint-content">
        <p><strong>How to Play:</strong> Fill the grid so every row, column, and 3x3 box contains the digits 1 to 9.</p>
      </div>
      
      <div class="hint-tips">
        <div class="hint-tip">
          <div class="tip-icon">1</div>
          <div>Start with the easiest cells - those with the fewest possible numbers.</div>
        </div>
        
        <div class="hint-tip">
          <div class="tip-icon">2</div>
          <div>Look for "naked singles" - cells where only one number is possible.</div>
        </div>
        
        <div class="hint-tip">
          <div class="tip-icon">3</div>
          <div>Check rows, columns, and boxes for missing numbers.</div>
        </div>
        
        <div class="hint-tip">
          <div class="tip-icon">4</div>
          <div>Use the "Highlight" feature to see related cells when you select a cell.</div>
        </div>
        
        <div class="hint-tip">
          <div class="tip-icon">5</div>
          <div>If you're stuck, use the "Solve" button to see the solution.</div>
        </div>
      </div>
    </div>
    
    <div class="grid-container">
      <div class="grid" id="sudoku-grid"></div>
      
      <div class="logic-box" id="logic-box">
        <div class="logic-title">
          <div class="logic-icon">i</div>
          <span>Solving Logic</span>
        </div>
        <div>Used backtracking algorithm to solve the puzzle:</div>
        <div class="logic-steps" id="logic-steps">
          <!-- Logic steps will be inserted here -->
        </div>
      </div>
    </div>
    
    <div class="sidebar">
      <div class="panel">
        <h3 class="panel-title">Number Pad</h3>
        <div class="num-buttons">
          <!-- Number buttons -->
          <button onclick="insertNumber(1)">1</button>
          <button onclick="insertNumber(2)">2</button>
          <button onclick="insertNumber(3)">3</button>
          <button onclick="insertNumber(4)">4</button>
          <button onclick="insertNumber(5)">5</button>
          <button onclick="insertNumber(6)">6</button>
          <button onclick="insertNumber(7)">7</button>
          <button onclick="insertNumber(8)">8</button>
          <button onclick="insertNumber(9)">9</button>
        </div>
      </div>
      
      <div class="panel">
        <h3 class="panel-title">Controls</h3>
        <div class="control-buttons">
          <button onclick="generatePuzzle()">Generate</button>
          <button onclick="solvePuzzle()">Solve</button>
          <button onclick="resetGrid()">Reset</button>
        </div>

        <!-- NEW UPLOAD SECTION -->
        <div class="upload-section">
          <button class="upload-button" onclick="document.getElementById('file-input').click()">
            Upload Your Puzzle
          </button>
          <input type="file" id="file-input" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
          <div id="upload-status" class="upload-status"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
const grid = document.getElementById("sudoku-grid");
let puzzle = [];
let solution = [];
let selectedCell = null;

// Create grid inputs
for (let r = 0; r < 9; r++) {
  for (let c = 0; c < 9; c++) {
    const input = document.createElement("input");
    input.type = "text";
    input.maxLength = 1;
    input.classList.add("cell");
    input.id = `cell-${r}-${c}`;
    input.addEventListener("focus", () => {
      selectedCell = {r, c};
      highlightCells(r, c);
    });
    grid.appendChild(input);
  }
}

function clearHighlights() {
  document.querySelectorAll(".cell").forEach(cell => {
    cell.classList.remove("highlight", "selected");
  });
}

function highlightCells(row, col) {
  clearHighlights();
  for (let i = 0; i < 9; i++) {
    document.getElementById(`cell-${row}-${i}`).classList.add("highlight");
    document.getElementById(`cell-${i}-${col}`).classList.add("highlight");
  }
  const startRow = Math.floor(row / 3) * 3;
  const startCol = Math.floor(col / 3) * 3;
  for (let r = 0; r < 3; r++) {
    for (let c = 0; c < 3; c++) {
      document.getElementById(`cell-${startRow+r}-${startCol+c}`).classList.add("highlight");
    }
  }
  document.getElementById(`cell-${row}-${col}`).classList.add("selected");
}

function insertNumber(num) {
  if (selectedCell) {
    const {r, c} = selectedCell;
    const cell = document.getElementById(`cell-${r}-${c}`);
    if (!cell.disabled) {
      cell.value = num;
      puzzle[r][c] = num;
      
      // Add animation when number is inserted
      cell.classList.remove('number-inserted');
      // Trigger reflow
      void cell.offsetWidth;
      cell.classList.add('number-inserted');
      
      // Remove animation class after animation completes
      setTimeout(() => {
        cell.classList.remove('number-inserted');
      }, 300);
    }
  }
}

async function generatePuzzle() {
  const res = await fetch("/generate");
  const data = await res.json();
  puzzle = data.puzzle;
  solution = data.solution;
  for (let r = 0; r < 9; r++) {
    for (let c = 0; c < 9; c++) {
      const cell = document.getElementById(`cell-${r}-${c}`);
      cell.value = puzzle[r][c] !== 0 ? puzzle[r][c] : "";
      cell.disabled = puzzle[r][c] !== 0;
    }
  }
  // Hide logic box when generating new puzzle
  document.getElementById("logic-box").classList.remove("visible");
}

async function solvePuzzle() {
  const res = await fetch("/solve", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({board: puzzle})
  });
  const data = await res.json();
  const solved = data.solution;
  for (let r = 0; r < 9; r++) {
    for (let c = 0; c < 9; c++) {
      document.getElementById(`cell-${r}-${c}`).value = solved[r][c];
    }
  }
  
  // Show logic box with solving steps
  showSolvingLogic();
}

function showSolvingLogic() {
  const logicBox = document.getElementById("logic-box");
  const logicSteps = document.getElementById("logic-steps");
  
  // Clear previous steps
  logicSteps.innerHTML = "";
  
  // Create logic steps
  const steps = [
    "Analyzed empty cells to find the one with fewest possibilities",
    "Applied backtracking to test possible numbers",
    "Checked row, column, and 3x3 box for conflicts",
    "Backtracked when no valid number was found",
    "Repeated until all cells were filled correctly"
  ];
  
  // Add steps to the logic box
  steps.forEach((step, index) => {
    const stepElement = document.createElement("div");
    stepElement.className = "logic-step";
    stepElement.innerHTML = `
      <div class="step-number">${index + 1}</div>
      <div>${step}</div>
    `;
    logicSteps.appendChild(stepElement);
  });
  
  // Show the logic box with animation
  logicBox.classList.add("visible");
}

function resetGrid() {
  clearHighlights();
  for (let r = 0; r < 9; r++) {
    for (let c = 0; c < 9; c++) {
      const cell = document.getElementById(`cell-${r}-${c}`);
      cell.value = "";
      cell.disabled = false;
    }
  }
  puzzle = Array.from({length: 9}, () => Array(9).fill(0));
  selectedCell = null;
  
  // Hide logic box when resetting
  document.getElementById("logic-box").classList.remove("visible");
}

// NEW FUNCTION: Handle image upload and fill board with extracted puzzle
function handleImageUpload(event) {
    const file = event.target.files[0];
    const statusElement = document.getElementById('upload-status');
    
    if (!file) {
        return;
    }

    // Check if file is an image
    if (!file.type.match('image.*')) {
        statusElement.textContent = 'Please upload an image file.';
        statusElement.className = 'upload-status error';
        return;
    }

    // Show processing status
    statusElement.textContent = 'Extracting puzzle from image... Please wait.';
    statusElement.className = 'upload-status processing';

    const formData = new FormData();
    formData.append('image', file);

    // Send image to backend for puzzle extraction
    fetch('/upload-puzzle', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusElement.textContent = data.message || 'Puzzle loaded successfully!';
            statusElement.className = 'upload-status success';
            
            // Fill the grid with the extracted puzzle
            const extractedPuzzle = data.puzzle;
            puzzle = extractedPuzzle;
            
            for (let r = 0; r < 9; r++) {
                for (let c = 0; c < 9; c++) {
                    const cell = document.getElementById(`cell-${r}-${c}`);
                    if (extractedPuzzle[r][c] !== 0) {
                        cell.value = extractedPuzzle[r][c];
                        cell.disabled = true; // Make pre-filled cells non-editable
                    } else {
                        cell.value = "";
                        cell.disabled = false; // Make empty cells editable
                    }
                }
            }
            
            // Clear highlights and hide logic box
            clearHighlights();
            document.getElementById("logic-box").classList.remove("visible");
            selectedCell = null;
            
        } else {
            statusElement.textContent = data.error || 'Failed to extract puzzle from image. Please try again.';
            statusElement.className = 'upload-status error';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusElement.textContent = 'Error processing image. Please try again.';
        statusElement.className = 'upload-status error';
    })
    .finally(() => {
        // Clear the file input
        event.target.value = '';
    });
}
  </script>
</body>
</html>